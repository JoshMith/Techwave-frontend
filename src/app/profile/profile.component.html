<!-- Header Navigation -->
<app-header></app-header>

<!-- Loading State -->
<div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading your profile...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !isLoading" class="error-container">
    <p>{{ error }}</p>
    <button (click)="loadUserData()" class="retry-btn">Retry</button>
</div>

<!-- Main Profile Content -->
<main class="profile-container" *ngIf="!isLoading && !error && user">
    <!-- Welcome Banner -->
    <div class="welcome-banner">
        <div class="container">
            <h1>Welcome back, {{ user.name }}!</h1>
            <p>{{ user.email }}</p>
        </div>
    </div>

    <div class="container profile-content">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <!-- Profile Card -->
            <div class="profile-card">
                <div class="avatar">{{ getUserInitials() }}</div>
                <h3>{{ user.name }}</h3>
                <p>{{ user.email }}</p>
                <p class="joined">Member since {{ getMemberSince() }}</p>
            </div>

            <!-- Navigation -->
            <nav class="profile-nav">
                <a (click)="setActiveSection('overview')" [class.active]="activeSection === 'overview'"
                    class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <rect x="3" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2" />
                        <rect x="14" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2" />
                        <rect x="14" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2" />
                        <rect x="3" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2" />
                    </svg>
                    Dashboard
                </a>
                <a (click)="setActiveSection('orders')" [class.active]="activeSection === 'orders'" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path
                            d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15"
                            stroke="currentColor" stroke-width="2" />
                        <path d="M12 12H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        <circle cx="9" cy="12" r="1" fill="currentColor" />
                    </svg>
                    My Orders
                </a>
                <a (click)="setActiveSection('addresses')" [class.active]="activeSection === 'addresses'"
                    class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path
                            d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z"
                            stroke="currentColor" stroke-width="2" />
                        <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" />
                    </svg>
                    Addresses
                </a>
                <a (click)="setActiveSection('payments')" [class.active]="activeSection === 'payments'"
                    class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <rect x="2" y="5" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2" />
                        <path d="M2 10H22" stroke="currentColor" stroke-width="2" />
                    </svg>
                    Payment History
                </a>
                <a (click)="setActiveSection('settings')" [class.active]="activeSection === 'settings'"
                    class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" />
                        <path
                            d="M12 1V3M12 21V23M4.22 4.22L5.64 5.64M18.36 18.36L19.78 19.78M1 12H3M21 12H23M4.22 19.78L5.64 18.36M18.36 5.64L19.78 4.22"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    Settings
                </a>
                <a (click)="logout()" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path
                            d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9"
                            stroke="currentColor" stroke-width="2" />
                        <path d="M16 17L21 12L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    Logout
                </a>
            </nav>

            <!-- Decorative Image -->
            <div class="random-image-container">
                <img src="https://i.pinimg.com/736x/d1/d0/84/d1d084b862d95e03101d0bf3bddc51be.jpg" alt="Decorative"
                    class="random-image" />
            </div>
        </aside>

        <!-- Main Dashboard Content -->
        <div class="dashboard">
            <!-- Dashboard Overview -->
            <div *ngIf="activeSection === 'overview'">
                <!-- Account Stats -->
                <div class="stats-section">
                    <div class="stat-card">
                        <div class="stat-value">{{ getActiveOrdersCount() }}</div>
                        <div class="stat-label">Active Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ orders.length }}</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ addresses.length }}</div>
                        <div class="stat-label">Saved Addresses</div>
                    </div>
                </div>



                <!-- Recent Orders Preview -->
                <section class="recent-orders" *ngIf="orders.length > 0">
                    <div class="section-header">
                        <h2>Recent Orders</h2>
                        <button (click)="setActiveSection('orders')" class="view-all-btn">View All</button>
                    </div>
                    <div class="orders-list">
                        <div *ngFor="let order of orders.slice(0, 3)" class="order-item">
                            <div class="order-info">
                                <h3>Order #{{ order.order_id }}</h3>
                                <div class="order-status" [ngClass]="getOrderStatusClass(order.status)">
                                    {{ order.status }}
                                </div>
                            </div>
                            <div class="order-date">{{ formatDate(order.created_at) }}</div>
                            <div class="order-details">
                                <span class="order-total">KSh {{ order.total_amount.toLocaleString() }}</span>
                            </div>
                            <button (click)="viewOrderDetails(order.order_id)" class="view-details">View
                                Details</button>
                        </div>
                    </div>
                </section>

                <!-- No Orders Message -->
                <section class="recent-orders" *ngIf="orders.length === 0">
                    <h2>Recent Orders</h2>
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                            <path
                                d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15"
                                stroke="currentColor" stroke-width="2" />
                        </svg>
                        <p>You haven't placed any orders yet.</p>
                        <button routerLink="/shop" class="shop-btn">Start Shopping</button>
                    </div>
                </section>
            </div>

            <!-- Orders Section -->
            <div *ngIf="activeSection === 'orders'" class="section-content">
                <h2 class="section-title">My Orders</h2>

                <div *ngIf="orders.length > 0" class="orders-list">
                    <div *ngFor="let order of orders" class="order-card" [class.expanded]="order.isExpanded">
                        <div class="order-header">
                            <div>
                                <h3>Order #{{ order.order_id }}</h3>
                                <p class="order-date">{{ formatDate(order.created_at) }}</p>
                            </div>
                            <div class="order-status-badge" [ngClass]="getOrderStatusClass(order.status)">
                                {{ order.status }}
                            </div>
                        </div>

                        <div class="order-summary">
                            <div class="order-total-amount">
                                <span class="label">Total Amount:</span>
                                <span class="amount">KSh {{ order.total_amount.toLocaleString() }}</span>
                            </div>
                        </div>

                        <!-- Expanded Order Details -->
                        <div *ngIf="order.isExpanded" class="order-details-expanded">
                            <!-- Customer Information -->
                            <div class="details-section">
                                <h4>Customer Information</h4>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="label">Name:</span>
                                        <span class="value">{{ order.name || 'Not provided' }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Email:</span>
                                        <span class="value">{{ order.email || 'Not provided' }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Phone:</span>
                                        <span class="value">{{ order.phone || 'Not provided' }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Items -->
                            <div class="details-section" *ngIf="order.order_items && order.order_items.length > 0">
                                <h4>Order Items ({{ order.order_items.length }})</h4>
                                <div class="order-items-list">
                                    <div *ngFor="let item of order.order_items" class="order-item-detail">
                                        <div class="item-info">
                                            <h5>{{ item.product_title }}</h5>
                                            <p class="item-description" *ngIf="item.product_description">
                                                {{ item.product_description }}
                                            </p>
                                            <div class="item-meta">
                                                <span>Quantity: {{ item.quantity }}</span>
                                                <span>Unit Price: KSh {{ item.unit_price.toLocaleString() }}</span>
                                                <span *ngIf="item.discount > 0">Discount: KSh {{
                                                    item.discount.toLocaleString() }}</span>
                                            </div>
                                        </div>
                                        <div class="item-total">
                                            KSh {{ getOrderItemTotal(item).toLocaleString() }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Summary -->
                            <div class="details-section">
                                <h4>Order Summary</h4>
                                <div class="summary-grid">
                                    <div class="summary-item">
                                        <span class="label">Subtotal:</span>
                                        <span class="value">KSh {{ getOrderSubtotal(order).toLocaleString() }}</span>
                                    </div>
                                    <div class="summary-item" *ngIf="getOrderDiscountTotal(order) > 0">
                                        <span class="label">Total Discount:</span>
                                        <span class="value">-KSh {{ getOrderDiscountTotal(order).toLocaleString()
                                            }}</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="label">Shipping:</span>
                                        <span class="value">KSh {{ (order.total_amount - getOrderSubtotal(order) +
                                            getOrderDiscountTotal(order)).toLocaleString() }}</span>
                                    </div>
                                    <div class="summary-item total">
                                        <span class="label">Total Amount:</span>
                                        <span class="value">KSh {{ order.total_amount.toLocaleString() }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Notes -->
                            <div class="details-section" *ngIf="order.notes">
                                <h4>Order Notes</h4>
                                <p class="order-notes">{{ order.notes }}</p>
                            </div>
                        </div>

                        <div class="order-footer">
                            <button (click)="viewOrderDetails(order.order_id)" class="view-details-btn">
                                {{ order.isExpanded ? 'Hide Details' : 'View Details' }}
                            </button>
                        </div>
                    </div>
                </div>

                <div *ngIf="orders.length === 0" class="empty-state">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
                        <path
                            d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15"
                            stroke="currentColor" stroke-width="2" />
                    </svg>
                    <h3>No orders yet</h3>
                    <p>Start shopping to place your first order!</p>
                    <button routerLink="/shop" class="shop-btn">Browse Products</button>
                </div>
            </div>

            <!-- Addresses Section -->
            <div *ngIf="activeSection === 'addresses'" class="section-content">
                <div class="section-header">
                    <h2 class="section-title">Saved Addresses</h2>
                </div>

                <div *ngIf="addresses.length > 0" class="addresses-grid">
                    <div *ngFor="let address of addresses" class="address-card">
                        <div class="address-header">
                            <h3>Address: #{{ address.address_id }}</h3>
                            <span *ngIf="address.is_default" class="default-badge">Default</span>
                        </div>

                        <!-- View Mode -->
                        <div *ngIf="editingAddressId !== address.address_id" class="address-content">
                            <p></p>
                            <p>{{ address.street }}</p>
                            <p *ngIf="address.building">{{ address.building }}</p>
                            <p>{{ address.city }}, {{ address.county }} {{ address.postal_code }}</p>
                            <p>{{ address.country }}</p>

                            <div class="address-actions">
                                <button (click)="startEditAddress(address)" class="edit-btn">Edit</button>
                                <button *ngIf="!address.is_default" (click)="setDefaultAddress(address.address_id)"
                                    class="default-btn">Set as Default</button>
                                <button (click)="deleteAddress(address.address_id)" class="delete-btn">Delete</button>
                            </div>
                        </div>

                        <!-- Edit Mode -->
                        <div *ngIf="editingAddressId === address.address_id" class="address-edit-form">
                            <div class="form-group">
                                <label>Address Line 1</label>
                                <input type="text" [(ngModel)]="editAddressData.street" class="form-input" />
                            </div>
                            <div class="form-group">
                                <label>Address Line 2 (Optional)</label>
                                <input type="text" [(ngModel)]="editAddressData.building" class="form-input" />
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>City</label>
                                    <input type="text" [(ngModel)]="editAddressData.city" class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label>State/County</label>
                                    <input type="text" [(ngModel)]="editAddressData.county" class="form-input" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Postal Code</label>
                                    <input type="text" [(ngModel)]="editAddressData.postal_code" class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label>Country</label>
                                    <input type="text" [(ngModel)]="editAddressData.country" class="form-input" />
                                </div>
                            </div>

                            <div class="form-actions">
                                <button (click)="saveAddress(address.address_id)" class="save-btn">Save</button>
                                <button (click)="cancelEditAddress()" class="cancel-btn">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Add New Address Card -->
                    <div class="address-card add-address-card">
                        <h3>Add New Address</h3>
                        <div class="form-group">
                            <label> Address Line 1</label>
                            <input type="text" [(ngModel)]="newAddress.street" class="form-input"
                                placeholder="Street address" />
                        </div>
                        <div class="form-group">
                            <label>Address Line 2 (Optional)</label>
                            <input type="text" [(ngModel)]="newAddress.building" class="form-input"
                                placeholder="Apartment, suite, etc." />
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" [(ngModel)]="newAddress.city" class="form-input"
                                    placeholder="Nairobi" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Postal Code</label>
                                <input type="text" [(ngModel)]="newAddress.postal_code" class="form-input"
                                    placeholder="00100" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Country</label>
                                <input type="text" [(ngModel)]="newAddress.country" class="form-input" value="Kenya"
                                    readonly />
                            </div>
                        </div>
                        <button (click)="addNewAddress()" class="add-btn">Add Address</button>
                    </div>
                </div>
            </div>

            <div *ngIf="addresses.length === 0" class="empty-state">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
                    <path
                        d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z"
                        stroke="currentColor" stroke-width="2" />
                    <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" />
                </svg>
                <h3>No saved addresses</h3>
                <p>Add your first delivery address!</p>
            </div>
        </div>

        <!-- Payments Section -->
        <div *ngIf="activeSection === 'payments'" class="section-content">
            <h2 class="section-title">Payment History</h2>

            <div *ngIf="payments.length > 0" class="payments-grid">
                <div *ngFor="let payment of payments" class="payment-card">
                    <div class="payment-header">
                        <div>
                            <h3>Payment #{{ payment.payment_id }}</h3>
                            <p class="payment-date">{{ formatDate(payment.created_at) }}</p>
                        </div>
                        <div class="payment-status-badge" [ngClass]="getPaymentStatusClass(payment)">
                            {{ payment.status }}
                        </div>
                    </div>
                    <div class="payment-body">
                        <div class="payment-info">
                            <span class="label">Order ID:</span>
                            <span class="value">#{{ payment.order_id }}</span>
                        </div>
                        <div class="payment-info">
                            <span class="label">Payment Method:</span>
                            <span class="value">{{ payment.method }}</span>
                        </div>
                        <div class="payment-info">
                            <span class="label">Amount:</span>
                            <span class="value amount">KSh {{ payment.amount.toLocaleString() }}</span>
                        </div>
                        <div class="payment-info" *ngIf="payment.transaction_reference">
                            <span class="label">Transaction ID:</span>
                            <span class="value">{{ payment.transaction_reference }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="payments.length === 0" class="empty-state">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
                    <rect x="2" y="5" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2" />
                    <path d="M2 10H22" stroke="currentColor" stroke-width="2" />
                </svg>
                <h3>No payment history</h3>
                <p>Your payment transactions will appear here.</p>
            </div>
        </div>

        <!-- Settings Section -->
        <div *ngIf="activeSection === 'settings'" class="section-content">
            <h2 class="section-title">Account Settings</h2>

            <div class="settings-card">
                <h3>Personal Information</h3>

                <!-- View Mode -->
                <div *ngIf="!isEditingProfile" class="profile-info">
                    <div class="info-row">
                        <span class="label">Name:</span>
                        <span class="value">{{ user.name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Email:</span>
                        <span class="value">{{ user.email }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Phone:</span>
                        <span class="value">{{ user.phone || 'Not provided' }}</span>
                    </div>
                    <button (click)="toggleEditProfile()" class="edit-profile-btn">Edit Profile</button>
                </div>

                <!-- Edit Mode -->
                <div *ngIf="isEditingProfile" class="profile-edit-form">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" [(ngModel)]="editUserData.name" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" [(ngModel)]="editUserData.email" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" [(ngModel)]="editUserData.phone" class="form-input" placeholder="+254..." />
                    </div>

                    <div class="form-actions">
                        <button (click)="saveProfile()" class="save-btn">Save Changes</button>
                        <button (click)="cancelEditProfile()" class="cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="settings-card">
                <h3>Security</h3>
                <p>Change your password or update security settings</p>
                <button class="secondary-btn" disabled>Change Password (Coming Soon)</button>
            </div>

            <div class="settings-card danger-zone">
                <h3>Danger Zone</h3>
                <p>Permanently delete your account and all associated data</p>
                <button class="danger-btn" disabled>Delete Account (Coming Soon)</button>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<app-footer></app-footer>