<!-- details.component.html -->
<div class="details-container">
  <div class="checkout-header">
    <button class="back-btn" (click)="goBack()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round" />
      </svg>
      Back to Cart
    </button>
    <h1>Checkout Details</h1>
    <div class="checkout-steps">
      <div class="step active">
        <span class="step-number">1</span>
        <span class="step-label">Details</span>
      </div>
      <div class="step">
        <span class="step-number">2</span>
        <span class="step-label">Payment</span>
      </div>
      <div class="step">
        <span class="step-number">3</span>
        <span class="step-label">Confirmation</span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading checkout details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-state">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Checkout Error</h3>
    <p>{{error}}</p>
    <button (click)="goBack()" class="btn btn-primary">
      Return to Cart
    </button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !error && orderData" class="details-content">
    <div class="details-layout">
      <!-- Left Column - Forms -->
      <div class="details-forms">
        <!-- Contact Information -->
        <div class="form-section">
          <h2>Contact Information</h2>
          <div class="form-group">
            <label for="email">Email Address *</label>
            <input id="email" type="email" [(ngModel)]="contactInfo.email" placeholder="your@email.com" required>
          </div>
          <div class="form-group">
            <label for="phone">Phone Number *</label>
            <input id="phone" type="tel" [(ngModel)]="contactInfo.phone" placeholder="+254 712 345 678" required>
          </div>
        </div>

        <!-- Delivery Address -->
        <div class="form-section">
          <div class="section-header">
            <h2>Delivery Address</h2>
            <button (click)="toggleAddressForm()" class="add-address-btn">
              {{ showAddressForm ? 'Cancel' : '+ Add New Address' }}
            </button>
          </div>

          <!-- Loading Addresses -->
          <div *ngIf="isLoadingAddresses" class="loading">
            Loading addresses...
          </div>

          <!-- Address Error -->
          <div *ngIf="addressError && !isLoadingAddresses" class="address-error">
            <p>{{addressError}}</p>
          </div>

          <!-- Address Options -->
          <div *ngIf="!isLoadingAddresses && addresses.length > 0" class="addresses-list">
            <div *ngFor="let address of addresses" class="address-card"
              [class.selected]="selectedAddressId === address.address_id" (click)="selectAddress(address.address_id)">
              <input type="radio" [value]="address.address_id" [(ngModel)]="selectedAddressId" name="address">
              <div class="address-content">
                <p class="address-line">{{ address.address_line1 }}</p>
                <p class="address-line" *ngIf="address.address_line2">{{ address.address_line2 }}</p>
                <p class="address-line">{{ address.city }}, {{ address.state }} {{ address.postal_code }}</p>
                <p class="address-line">{{ address.country }}</p>
                <span *ngIf="address.is_default" class="default-badge">Default</span>
              </div>
            </div>
          </div>

          <!-- No Addresses -->
          <div *ngIf="!isLoadingAddresses && addresses.length === 0 && !showAddressForm && !addressError"
            class="no-addresses">
            <p>No addresses saved. Please add a delivery address.</p>
          </div>

          <!-- New Address Form -->
          <div *ngIf="showAddressForm" class="new-address-form">
            <h3>Add New Address</h3>
            
            <!-- Map Picker Button -->
            <div class="form-group">
              <button type="button" (click)="openMapPicker()" class="map-picker-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                üìç Select Location on Map
              </button>
            </div>

            <div class="form-group">
              <label for="address_line1">Address Line 1 *</label>
              <input type="text" id="address_line1" [(ngModel)]="newAddress.address_line1"
                placeholder="Street address, P.O. Box" required>
            </div>
            <div class="form-group">
              <label for="address_line2">Address Line 2</label>
              <input type="text" id="address_line2" [(ngModel)]="newAddress.address_line2"
                placeholder="Apartment, suite, unit, building, floor, etc.">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" [(ngModel)]="newAddress.city" placeholder="City" required>
              </div>
              <div class="form-group">
                <label for="state">State/Province *</label>
                <input type="text" id="state" [(ngModel)]="newAddress.state" placeholder="State or Province" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="postal_code">Postal Code *</label>
                <input type="text" id="postal_code" [(ngModel)]="newAddress.postal_code" placeholder="Postal code"
                  required>
              </div>
              <div class="form-group">
                <label for="country">Country *</label>
                <input type="text" id="country" [(ngModel)]="newAddress.country" placeholder="Country" required>
              </div>
            </div>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="newAddress.is_default">
                Set as default address
              </label>
            </div>
            <button (click)="saveNewAddress()" class="save-address-btn">
              Save Address
            </button>
          </div>
        </div>

        <!-- Delivery Method -->
        <div class="form-section">
          <h2>Delivery Method</h2>
          <div class="delivery-options">
            <div *ngFor="let option of deliveryOptions" class="delivery-option"
              [class.selected]="selectedDelivery === option.id" (click)="changeDelivery(option.id)">
              <input type="radio" [value]="option.id" [checked]="selectedDelivery === option.id" name="delivery"
                (change)="changeDelivery(option.id)">
              <div class="delivery-info">
                <div>
                  <span class="delivery-name">{{option.name}}</span>
                  <span class="delivery-estimate">{{option.estimate}}</span>
                </div>
                <span class="delivery-cost">{{option.cost | currency:'KSh '}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Order Summary -->
    <div class="order-summary-section">
      <div class="order-summary-sticky">
        <h2>Order Summary</h2>

        <!-- Order Items -->
        <div class="summary-items">
          <div *ngFor="let item of orderItems" class="summary-item">
            <img [src]="item.image_url || 'assets/images/placeholder-product.png'" [alt]="item.product_title"
              class="item-image">
            <div class="item-details">
              <h4>{{item.product_title}}</h4>
              <p class="item-quantity">Qty: {{item.quantity}}</p>
            </div>
            <div class="item-price">
              {{item.subtotal | currency:'KSh '}}
            </div>
          </div>
        </div>

        <!-- Order Totals -->
        <div class="price-breakdown">
          <div class="price-row">
            <span>Subtotal</span>
            <span>{{orderData.subtotal | currency:'KSh '}}</span>
          </div>
          <div class="price-row">
            <span>Shipping</span>
            <span>{{selectedDeliveryOption.cost | currency:'KSh '}}</span>
          </div>
          <div class="price-row">
            <span>Tax (16% VAT)</span>
            <span>{{orderData.tax | currency:'KSh '}}</span>
          </div>
          <div *ngIf="orderData.couponDiscount > 0" class="price-row discount">
            <span>Discount</span>
            <span>-{{orderData.couponDiscount | currency:'KSh '}}</span>
          </div>
          <div class="price-row total">
            <strong>Total</strong>
            <strong>{{finalTotal | currency:'KSh '}}</strong>
          </div>
        </div>

        <!-- Proceed Button -->
        <button (click)="proceedToPayment()" [disabled]="isProcessing" class="proceed-btn">
          <span *ngIf="!isProcessing">Proceed to Payment</span>
          <span *ngIf="isProcessing">Processing...</span>
        </button>

        <!-- Security Notice -->
        <div class="security-info">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span>Your payment information is secure and encrypted</span>
        </div>
      </div>
    </div>
  </div>

  <!-- No order data message -->
  <div *ngIf="!isLoading && !error && !orderData" class="no-data">
    <p>No order data available. Please start from the cart.</p>
    <button class="back-btn" (click)="goBack()">Go to Cart</button>
  </div>

  <!-- Debug Button (Remove in production) -->
  <button *ngIf="!isLoading && !error && orderData" (click)="debugCheckout()" class="debug-btn">
    Debug
  </button>
</div>

<!-- Map Picker Modal -->
<div *ngIf="showMapPicker" class="map-modal-overlay" (click)="closeMapPicker()">
  <div class="map-modal" (click)="$event.stopPropagation()">
    <div class="map-modal-header">
      <h3>Select Your Delivery Location</h3>
      <button class="close-btn" (click)="closeMapPicker()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <!-- Search Box -->
    <div class="map-search-box">
      <input 
        type="text" 
        #searchInput 
        placeholder="Search for a location (e.g., Westlands, Nairobi)"
        (keyup.enter)="searchLocation(searchInput.value)"
        class="map-search-input">
      <button (click)="searchLocation(searchInput.value)" class="map-search-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <!-- Map Container -->
    <div class="map-container">
      <div *ngIf="isLoadingMap" class="map-loading">
        <div class="spinner"></div>
        <p>Loading map...</p>
      </div>
      <div id="map-canvas" class="map-canvas"></div>
    </div>

    <!-- Selected Address Display -->
    <div class="selected-address-display" *ngIf="newAddress.address_line1">
      <div class="address-icon">üìç</div>
      <div class="address-text">
        <strong>Selected Location:</strong>
        <p>{{ newAddress.address_line1 }}</p>
        <p>{{ newAddress.city }}, {{ newAddress.state }} {{ newAddress.postal_code }}</p>
      </div>
    </div>

    <!-- Map Instructions -->
    <div class="map-instructions">
      <p>üí° <strong>Tip:</strong> Click on the map or drag the marker to select your exact delivery location</p>
    </div>

    <!-- Modal Actions -->
    <div class="map-modal-actions">
      <button (click)="closeMapPicker()" class="btn-secondary">Cancel</button>
      <button (click)="confirmLocation()" class="btn-primary" [disabled]="!newAddress.address_line1">
        Confirm Location
      </button>
    </div>
  </div>
</div>