<!-- Header Navigation -->
<header class="header">
  <nav class="nav-container">
    <div class="logo-section">
      <a routerLink="/" class="logo">
        <img routerLink="/" src="favicon.ico" width="50px" alt="Logo">
      </a>
      <span class="seller-badge">Seller Portal</span>
    </div>
    <div class="nav-items">
      <button class="nav-link" [class.active]="currentView === 'dashboard'" (click)="goToDashboard()" [disabled]="!isSeller">Dashboard</button>
      <button class="nav-link" [class.active]="currentView === 'products'"
        (click)="navigateTo('products')" [disabled]="!isSeller">Products</button>
      <button class="nav-link" [class.active]="currentView === 'manage-orders'"
        (click)="navigateTo('manage-orders')" [disabled]="!isSeller">Orders</button>
      <button class="nav-link" [class.active]="currentView === 'analytics'"
        (click)="navigateTo('analytics')" [disabled]="!isSeller">Analytics</button>
      <button class="nav-link" [class.active]="currentView === 'promotions'"
        (click)="navigateTo('promotions')" [disabled]="!isSeller">Promotions</button>
      <button class="nav-link" [class.active]="currentView === 'profile'" (click)="onProfileClick()">Profile</button>
    </div>
    <div class="profile-section">
      <button class="notification-btn" title="Notifications" (click)="onNotificationClick()">
        üîî
        <span class="notification-count" *ngIf="notificationCount > 0">{{notificationCount}}</span>
      </button>
      <div class="profile-avatar" title="Profile" (click)="onProfileClick()">
        {{userName.charAt(0).toUpperCase()}}
      </div>
    </div>
  </nav>
</header>

<!-- Main Content -->
<main class="main-content">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading dashboard data...</p>
  </div>

  <!-- Unauthorized Access -->
  <div *ngIf="!isLoading && !isAuthorized && !error" class="unauthorized-container">
    <div class="unauthorized-message">
      <span class="unauthorized-icon">üö´</span>
      <h2>Access Denied</h2>
      <p>You don't have permission to access the seller dashboard.</p>
      <p>This area is restricted to sellers and administrators only.</p>
      <div class="unauthorized-actions">
        <a routerLink="/" class="btn btn-primary">Go to Home</a>
        <a routerLink="/shop" class="btn btn-secondary">Continue Shopping</a>
      </div>
      <div class="user-info">
        <small>Logged in as: <strong>{{userName}}</strong> ({{userRole}})</small>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <div class="error-message">
      <span class="error-icon">‚ö†Ô∏è</span>
      <p>{{error}}</p>
      <button class="btn btn-primary" (click)="refreshData()">Retry</button>
    </div>
  </div>

  <!-- Dashboard Content - Only show if authorized -->
  <div *ngIf="!isLoading && !error && isAuthorized">

    <!-- ===== DASHBOARD VIEW ===== -->
    <div *ngIf="currentView === 'dashboard'">
      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <h1 class="dashboard-title">Welcome back, {{userName}}!</h1>
        <p class="dashboard-subtitle">Here's what's happening with your store today</p>
        <button class="refresh-btn" (click)="refreshData()" title="Refresh Data">
          üîÑ Refresh
        </button>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card" *ngFor="let stat of stats">
          <div class="stat-header">
            <div>
              <div class="stat-title">{{stat.title}}</div>
              <div class="stat-value">{{stat.value}}</div>
              <div class="stat-change" [ngClass]="stat.changeClass">
                <span class="change-arrow" *ngIf="stat.changeClass === 'positive'">‚Üó</span>
                <span class="change-arrow" *ngIf="stat.changeClass === 'negative'">‚Üò</span>
                <span>{{stat.change}}</span>
              </div>
            </div>
            <div class="stat-icon" [ngClass]="stat.iconClass">{{stat.icon}}</div>
          </div>
        </div>
      </div>

      <!-- Dashboard Grid -->
      <div class="dashboard-grid">
        <!-- Main Panel -->
        <div class="main-panel">
          <!-- Recent Orders -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Recent Orders</h2>
              <button class="view-all-btn" (click)="navigateTo('manage-orders')">View All Orders</button>
            </div>
            <div class="table-container">
              <div *ngIf="orders.length === 0" class="empty-state">
                <p>No orders found</p>
                <small>Your recent orders will appear here</small>
              </div>
              <table class="orders-table" *ngIf="orders.length > 0">
                <thead>
                  <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let order of orders" (click)="onOrderClick(order.id)">
                    <td><span class="order-id">#{{order.id}}</span></td>
                    <td>{{order.customer}}</td>
                    <td>{{order.product}}</td>
                    <td>{{order.amount}}</td>
                    <td><span class="status-badge" [ngClass]="order.statusClass">{{order.status}}</span></td>
                    <td>{{order.date}}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Sales Chart -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Sales Overview</h2>
              <select class="view-all-btn" style="border: none; background: transparent;">
                <option>Last 7 days</option>
                <option>Last 30 days</option>
                <option>Last 3 months</option>
              </select>
            </div>
            <div class="chart-container">
              <div class="mock-chart" *ngIf="analyticsData.revenueByMonth.length > 0">
                <div class="chart-bars">
                  <div *ngFor="let data of analyticsData.revenueByMonth" class="chart-bar">
                    <div class="bar revenue-bar" [style.height.px]="(data.revenue / 10000) * 2"></div>
                    <span class="bar-label">{{data.month}}</span>
                  </div>
                </div>
              </div>
              <div *ngIf="analyticsData.revenueByMonth.length === 0">
                üìà Sales Chart
                <br>
                <small>Sales data will appear here once you have orders</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar Panel -->
        <div class="sidebar-panel">
          <!-- Quick Actions -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="quick-actions">
              <button *ngFor="let action of quickActions" class="quick-action-btn"
                (click)="onQuickActionClick(action.action)">
                <div class="action-icon">{{action.icon}}</div>
                <span class="action-text">{{action.text}}</span>
              </button>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Recent Activity</h3>
            </div>
            <div class="activity-list">
              <div *ngIf="activities.length === 0" class="empty-state">
                <p>No recent activity</p>
                <small>Your activities will appear here</small>
              </div>
              <div class="activity-item" *ngFor="let activity of activities">
                <div class="activity-icon" [ngClass]="activity.iconClass">{{activity.icon}}</div>
                <div class="activity-content">
                  <div class="activity-text">{{activity.text}}</div>
                  <div class="activity-time">{{activity.time}}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Store Performance -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Store Performance</h3>
            </div>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;"
                *ngFor="let metric of performanceMetrics">
                <span style="color: #6b7280;">{{metric.label}}</span>
                <span style="font-weight: 600;" [ngClass]="metric.valueClass">{{metric.value}}</span>
              </div>
              <div style="margin-top: 1rem;">
                <button class="btn btn-primary" style="width: 100%; justify-content: center;"
                  (click)="navigateTo('analytics')">
                  üìä View Detailed Analytics
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== ADD PRODUCT VIEW ===== -->
    <div *ngIf="currentView === 'add-product'">
      <div class="page-header">
        <button class="back-btn" (click)="goToDashboard()">‚Üê Back to Dashboard</button>
        <h1 class="page-title">Add New Product</h1>
      </div>

      <div class="form-container">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Product Information</h2>
          </div>

          <!-- Success/Error Messages -->
          <div *ngIf="productSuccess" class="alert alert-success">
            {{productSuccess}}
          </div>
          <div *ngIf="productError" class="alert alert-error">
            {{productError}}
          </div>

          <form class="product-form">
            <div class="form-group">
              <label for="productTitle">Product Title *</label>
              <input type="text" id="productTitle" [(ngModel)]="newProduct.title" name="productTitle" class="form-input"
                placeholder="Enter product title" required>
            </div>

            <div class="form-group">
              <label for="productDescription">Description *</label>
              <textarea id="productDescription" [(ngModel)]="newProduct.description" name="productDescription"
                class="form-textarea" rows="4" placeholder="Enter product description" required></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="productPrice">Regular Price (KSh) *</label>
                <input type="number" id="productPrice" [(ngModel)]="newProduct.price" name="productPrice"
                  class="form-input" placeholder="0" min="0" step="0.01" required>
              </div>

              <div class="form-group">
                <label for="productSalePrice">Sale Price (KSh)</label>
                <input type="number" id="productSalePrice" [(ngModel)]="newProduct.sale_price" name="productSalePrice"
                  class="form-input" placeholder="0" min="0" step="0.01">
                <small style="color: #6b7280; font-size: 0.8rem;">Optional: Leave empty if no sale</small>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="productStock">Stock Quantity *</label>
                <input type="number" id="productStock" [(ngModel)]="newProduct.stock" name="productStock"
                  class="form-input" placeholder="0" min="0" required>
              </div>

              <div class="form-group">
                <label for="productCategory">Category *</label>
                <select id="productCategory" [(ngModel)]="newProduct.category_id" name="productCategory"
                  class="form-select" required>
                  <option value="">Select a category</option>
                  <option *ngFor="let category of categories" [value]="category.category_id">
                    {{category.name}}
                  </option>
                </select>
              </div>
            </div>

            <!-- Product Images Section -->
            <div class="form-section">
              <h3 class="section-title">Product Images (Optional)</h3>

              <div class="form-group full-width">
                <label class="form-label">Upload Images</label>
                <div class="image-upload-area" (click)="fileInput.click()" (dragover)="onDragOver($event)"
                  (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
                  <div class="upload-icon">üì∑</div>
                  <div class="upload-text">Click to upload or drag and drop</div>
                  <div class="upload-subtext">PNG, JPG up to 5MB each. First image will be the main photo.</div>
                  <input #fileInput type="file" class="file-input" multiple accept="image/*"
                    (change)="onFileSelected($event)">
                </div>
                <div id="imagePreview" class="image-preview" *ngIf="uploadedImages.length > 0">
                  <div *ngFor="let image of uploadedImages; let i = index" class="image-preview-item">
                    <img [src]="image.url" [alt]="image.name" class="preview-image">
                    <button type="button" class="remove-image" (click)="removeImage(i)">√ó</button>
                  </div>
                </div>
                <span class="help-text">
                  <br>Add multiple angles - front, back, sides, ports, and any accessories included.
                </span>
                <div *ngIf="uploadedImages.length === 0" class="info-message">
                  ‚ÑπÔ∏è No images selected. Product will be created without images.
                </div>
              </div>
            </div>

            <!-- Technical Specifications Section -->
            <div class="form-section">
              <h3 class="section-title">Technical Specifications</h3>

              <div class="form-group full-width">
                <label class="form-label">Specifications</label>
                <div class="specs-container">
                  <div id="specsContainer">
                    <div *ngFor="let spec of specs; let i = index" class="spec-row">
                      <input type="text" class="spec-key" [(ngModel)]="spec.key" [ngModelOptions]="{standalone: true}"
                        placeholder="Feature name (e.g., Storage)">
                      <input type="text" class="spec-value" [(ngModel)]="spec.value"
                        [ngModelOptions]="{standalone: true}" placeholder="Value (e.g., 128GB)">
                      <button type="button" class="remove-spec-btn" (click)="removeSpecification(i)">√ó</button>
                    </div>
                  </div>
                  <button type="button" class="add-spec-btn" (click)="addSpecification()">+ Add Specification</button>
                </div>
                <span class="help-text">Add key specifications like storage, RAM, display size, etc.</span>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" (click)="goToDashboard()">Cancel</button>
              <button type="button" class="btn btn-primary" (click)="onAddProduct()">Add Product</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===== MANAGE PRODUCTS VIEW ===== -->
    <div *ngIf="currentView === 'products'">
      <div class="page-header">
        <button class="back-btn" (click)="goToDashboard()">‚Üê Back to Dashboard</button>
        <h1 class="page-title">Manage Products</h1>
        <button class="btn btn-primary" (click)="navigateTo('add-product')">+ Add Product</button>
      </div>

      <!-- Success/Error Messages -->
      <div *ngIf="productSuccess" class="alert alert-success">
        {{productSuccess}}
      </div>
      <div *ngIf="productError" class="alert alert-error">
        {{productError}}
      </div>

      <div class="card">
        <div class="table-container">
          <div *ngIf="products.length === 0" class="empty-state">
            <p>No products found</p>
            <small>Your products will appear here</small>
            <button class="btn btn-primary" (click)="navigateTo('add-product')" style="margin-top: 1rem;">
              Add Your First Product
            </button>
          </div>

          <table class="products-table" *ngIf="products.length > 0">
            <thead>
              <tr>
                <th>Product</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Status</th>
                <th>Rating</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let product of products">
                <td>
                  <div class="product-info">
                    <div class="product-name">{{product.title}}</div>
                    <div class="product-description">{{product.description | slice:0:50}}...</div>
                  </div>
                </td>
                <td>{{product.categoryName || product.category_name || product.category_id}}</td>
                <td>
                  <div *ngIf="product.sale_price; else regularPrice">
                    <span class="sale-price-main">{{formatCurrency(product.sale_price)}} </span>
                    <small style="text-decoration: line-through; color: red;"
                      class="original-price-small">{{formatCurrency(product.price)}}</small>
                  </div>
                  <ng-template #regularPrice>
                    {{formatCurrency(product.price)}}
                  </ng-template>
                </td>
                <td>
                  <span [ngClass]="product.stock <= 5 ? 'stock-low' : 'stock-good'">
                    {{product.stock}}
                  </span>
                </td>

                <td>
                  <span class="status-badge" [ngClass]="product.status === 'active' ? 'delivered' : 'cancelled'">
                    {{product.status || 'active'}}
                  </span>
                </td>
                <td>
                  <span class="rating">
                    ‚≠ê {{product.rating || 0}}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="btn-icon" (click)="onEditProduct(product)" title="Edit">‚úèÔ∏è</button>
                    <button class="btn-icon" (click)="onDeleteProduct(product.product_id)" title="Delete">üóëÔ∏è</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Edit Product Modal -->
      <div *ngIf="editingProduct" class="modal-overlay" (click)="editingProduct = null; editingProductImages = []; editingProductExistingImages = []">
        <div class="modal modal-large" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Edit Product</h3>
            <button class="modal-close" (click)="editingProduct = null; editingProductImages = []; editingProductExistingImages = []">√ó</button>
          </div>
          <div class="modal-content">
            <!-- Success/Error Messages -->
            <div *ngIf="productSuccess" class="alert alert-success" style="margin-bottom: 1rem;">
              {{productSuccess}}
            </div>
            <div *ngIf="productError" class="alert alert-error" style="margin-bottom: 1rem;">
              {{productError}}
            </div>

            <form class="product-form">
              <div class="form-group">
                <label>Product Name</label>
                <input type="text" [(ngModel)]="editingProduct.title" name="editName" class="form-input">
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea [(ngModel)]="editingProduct.description" name="editDescription" class="form-textarea"
                  rows="3"></textarea>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Price (KSh)</label>
                  <input type="number" [(ngModel)]="editingProduct.sale_price" name="editPrice" class="form-input">
                </div>
                <div class="form-group">
                  <label>Stock</label>
                  <input type="number" [(ngModel)]="editingProduct.stock" name="editStock" class="form-input">
                </div>
              </div>

              <!-- Product Images Section -->
              <div class="form-section">
                <h3 class="section-title">Product Images</h3>

                <!-- Existing Images -->
                <div class="form-group" *ngIf="editingProductExistingImages.length > 0">
                  <label class="form-label">Current Images</label>
                  <div class="image-preview">
                    <div *ngFor="let image of editingProductExistingImages" class="image-preview-item">
                      <img [src]="image.image_url" [alt]="image.alt_text" class="preview-image">
                      <button type="button" class="remove-image" (click)="removeExistingProductImage(image)">√ó</button>
                      <span *ngIf="image.is_primary" class="primary-badge">Primary</span>
                    </div>
                  </div>
                </div>

                <!-- Upload New Images -->
                <div class="form-group">
                  <label class="form-label">Add New Images</label>
                  <div class="image-upload-area" (click)="editFileInput.click()">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Click to upload new images</div>
                    <div class="upload-subtext">PNG, JPG up to 5MB each</div>
                    <input #editFileInput type="file" class="file-input" multiple accept="image/*"
                      (change)="onEditProductFileSelected($event)">
                  </div>

                  <!-- New Images Preview -->
                  <div class="image-preview" *ngIf="editingProductImages.length > 0">
                    <div *ngFor="let image of editingProductImages; let i = index" class="image-preview-item">
                      <img [src]="image.url" [alt]="image.name" class="preview-image">
                      <button type="button" class="remove-image" (click)="removeEditingProductImage(i)">√ó</button>
                      <span class="new-badge">New</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button type="button" class="btn btn-secondary" (click)="editingProduct = null; editingProductImages = []; editingProductExistingImages = []">Cancel</button>
                <button type="button" class="btn btn-primary" (click)="onUpdateProduct()">Update</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== MANAGE ORDERS VIEW ===== -->
    <div *ngIf="currentView === 'manage-orders'">
      <div class="page-header">
        <button class="back-btn" (click)="goToDashboard()">‚Üê Back to Dashboard</button>
        <h1 class="page-title">Manage Orders</h1>
      </div>

      <div class="filters-container">
        <div class="filter-group">
          <label>Filter by Status:</label>
          <select [(ngModel)]="orderFilter" (ngModelChange)="filterOrders()" class="form-select">
            <option value="all">All Orders</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Search Orders:</label>
          <input type="text" [(ngModel)]="orderSearch" (ngModelChange)="filterOrders()" class="form-input"
            placeholder="Search by ID, customer, or product">
        </div>
      </div>

      <div class="card">
        <div class="table-container">
          <div *ngIf="filteredOrders.length === 0" class="empty-state">
            <p>No orders found</p>
            <small>Orders matching your criteria will appear here</small>
          </div>

          <table class="orders-table" *ngIf="filteredOrders.length > 0">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Product</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let order of filteredOrders">
                <td><span class="order-id">{{order.order_id}}</span></td>
                <td>{{order.user_name || order.customer?.name || 'Unknown'}}</td>
                <td>{{order.product_name || order.items?.[0]?.productName || 'Unknown'}}</td>
                <td>{{formatCurrency(order.total_amount || order.total || 0)}}</td>
                <td>{{order.status | titlecase }}</td>
                <td>{{formatDate(order.created_at || order.orderDate)}}</td>
                <td>
                  <button class="btn-small btn-primary" (click)="onOrderClick(order.order_id)">View</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== ORDER DETAILS VIEW ===== -->
    <div *ngIf="currentView === 'order-details'">
      <div class="page-header">
        <button class="back-btn" (click)="closeOrderDetails()">‚Üê Back to Orders</button>
        <h1 class="page-title">Order Details</h1>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoadingOrderDetails" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading order details...</p>
      </div>

      <!-- Order Details Content -->
      <div *ngIf="!isLoadingOrderDetails && selectedOrder" style="display: grid; gap: 1.5rem;">

        <!-- Order Summary Card -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Order Summary</h2>
            <span class="status-badge" [ngClass]="getStatusClass(selectedOrder.status)">
              {{mapOrderStatus(selectedOrder.status)}}
            </span>
          </div>
          <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; padding: 1.5rem;">
            <div>
              <label class="profile-label">Order ID</label>
              <div class="profile-value">{{selectedOrder.order_id || selectedOrder.id}}</div>
            </div>
            <div>
              <label class="profile-label">Order Date</label>
              <div class="profile-value">{{formatDate(selectedOrder.created_at || selectedOrder.orderDate)}}</div>
            </div>
            <div>
              <label class="profile-label">Total Amount</label>
              <div class="profile-value" style="color: #10b981; font-weight: 600; font-size: 1.2rem;">
                {{formatCurrency(selectedOrder.total_amount || selectedOrder.total || 0)}}
              </div>
            </div>
            <div>
              <label class="profile-label">Payment Status</label>
              <div class="profile-value">
                <span class="status-badge" [ngClass]="orderDetails.payment?.confirmed ? 'delivered' : 'pending'">
                  {{orderDetails.payment?.confirmed ? 'Paid' : 'Pending'}}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Customer Information -->
        <div class="card" *ngIf="orderDetails.user">
          <div class="card-header">
            <h3 class="card-title">Customer Information</h3>
          </div>
          <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; padding: 1.5rem;">
            <div>
              <label class="profile-label">Name</label>
              <div class="profile-value">
                {{orderDetails.user.name || orderDetails.user.Name}}
              </div>
            </div>
            <div>
              <label class="profile-label">Email</label>
              <div class="profile-value">{{orderDetails.user.email}}</div>
            </div>
            <div>
              <label class="profile-label">Phone</label>
              <div class="profile-value">{{orderDetails.user.phone || 'N/A'}}</div>
            </div>
            <div>
              <label class="profile-label">Customer Since</label>
              <div class="profile-value">{{formatDate(orderDetails.user.created_at)}}</div>
            </div>
          </div>
        </div>

        <!-- Delivery Address -->
        <div class="card" *ngIf="orderDetails.address">
          <div class="card-header">
            <h3 class="card-title">Delivery Address</h3>
          </div>
          <div style="padding: 1.5rem;">
            <div class="profile-value" style="line-height: 1.8;">
              <div><strong>{{orderDetails.address.full_name || orderDetails.address.name}}</strong></div>
              <div>{{orderDetails.address.phone}}</div>
              <div style="margin-top: 0.5rem;">
                {{orderDetails.address.street_address}}<br>
                {{orderDetails.address.city}}, {{orderDetails.address.state}} {{orderDetails.address.postal_code}}<br>
                {{orderDetails.address.country}}
              </div>
              <div *ngIf="orderDetails.address.is_default" style="margin-top: 0.5rem;">
                <span class="status-badge delivered" style="font-size: 0.8rem;">Default Address</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Order Items</h3>
          </div>
          <div class="table-container">
            <table class="orders-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Quantity</th>
                  <th>Unit Price</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of orderDetails.items">
                  <td>{{item.product_id || item.productName || 'Unknown Product'}}</td>
                  <td>{{item.quantity}}</td>
                  <td>{{formatCurrency(item.price || item.unit_price || 0)}}</td>
                  <td style="font-weight: 600;">{{formatCurrency((item.price || item.unit_price || 0) * item.quantity)}}
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr style="border-top: 2px solid #e5e7eb; font-weight: 600;">
                  <td colspan="3" style="text-align: right; padding: 1rem;">Total:</td>
                  <td style="color: #10b981; font-size: 1.1rem;">
                    {{formatCurrency(selectedOrder.total_amount || selectedOrder.total || 0)}}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Payment Information -->
        <div class="card" *ngIf="orderDetails.payment">
          <div class="card-header">
            <h3 class="card-title">Payment Information</h3>
          </div>
          <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; padding: 1.5rem;">
            <div>
              <label class="profile-label">Payment Method</label>
              <div class="profile-value">{{orderDetails.payment.method || 'N/A'}}</div>
            </div>
            <div>
              <label class="profile-label">Transaction ID</label>
              <div class="profile-value">{{orderDetails.payment.transaction_reference || 'N/A'}}</div>
            </div>
            <div>
              <label class="profile-label">Amount Paid</label>
              <div class="profile-value" style="color: #10b981; font-weight: 600;">
                {{formatCurrency(orderDetails.payment.amount || 0)}}
              </div>
            </div>
            <div>
              <label class="profile-label">Payment Date</label>
              <div class="profile-value">{{formatDate(orderDetails.payment.created_at)}}</div>
            </div>
          </div>
        </div>

        <!-- Order Actions -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Update Order Status</h3>
          </div>
          <div style="padding: 1.5rem;">
            <div class="form-group">
              <label>Current Status: <strong>{{mapOrderStatus(selectedOrder.status)}}</strong></label>
              <select [(ngModel)]="selectedOrder.status"
                (ngModelChange)="updateOrderStatus(selectedOrder.order_id || selectedOrder.id, selectedOrder.status)"
                class="form-select" style="margin-top: 0.5rem;">
                <option value="pending">Pending</option>
                <option value="processing">Processing</option>
                <option value="shipped">Shipped</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ===== ANALYTICS VIEW ===== -->
    <div *ngIf="currentView === 'analytics'">
      <div class="page-header">
        <button class="back-btn" (click)="goToDashboard()">‚Üê Back to Dashboard</button>
        <h1 class="page-title">Analytics & Reports</h1>
      </div>

      <div class="analytics-grid">
        <!-- Sales Trend Chart -->
        <div class="card analytics-card">
          <div class="card-header">
            <h3 class="card-title">Sales Trend</h3>
          </div>
          <div class="chart-container">
            <div class="mock-chart" *ngIf="analyticsData.salesTrend.length > 0">
              <div class="chart-bars">
                <div *ngFor="let data of analyticsData.salesTrend" class="chart-bar">
                  <div class="bar" [style.height.px]="(data.sales / 1000) * 2"></div>
                  <span class="bar-label">{{data.month}}</span>
                </div>
              </div>
            </div>
            <div *ngIf="analyticsData.salesTrend.length === 0">
              üìà Sales trend data will appear here
            </div>
          </div>
        </div>

        <!-- Top Products -->
        <div class="card analytics-card">
          <div class="card-header">
            <h3 class="card-title">Top Selling Products</h3>
          </div>
          <div class="top-products">
            <div *ngIf="analyticsData.topProducts.length === 0" class="empty-state">
              <p>No product sales data yet</p>
            </div>
            <div *ngFor="let product of analyticsData.topProducts" class="product-item">
              <div class="product-details">
                <div class="product-name">{{product.name}}</div>
                <div class="product-stats">{{product.sales}} sold ‚Ä¢ {{formatCurrency(product.revenue)}}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Customer Statistics -->
        <div class="card analytics-card">
          <div class="card-header">
            <h3 class="card-title">Customer Statistics</h3>
          </div>
          <div class="stats-list">
            <div class="stat-item">
              <span class="stat-label">Total Orders</span>
              <span class="stat-value">{{analyticsData.customerStats.totalCustomers || 0}}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Customer Satisfaction</span>
              <span class="stat-value">{{analyticsData.customerStats.customerSatisfaction || 0}}/5.0</span>
            </div>
          </div>
        </div>

        <!-- Revenue Chart -->
        <div class="card analytics-card full-width">
          <div class="card-header">
            <h3 class="card-title">Monthly Revenue</h3>
          </div>
          <div class="chart-container">
            <div class="mock-chart" *ngIf="analyticsData.revenueByMonth.length > 0">
              <div class="chart-bars">
                <div *ngFor="let data of analyticsData.revenueByMonth" class="chart-bar">
                  <div class="bar revenue-bar" [style.height.px]="(data.revenue / 10000) * 2"></div>
                  <span class="bar-label">{{data.month}}</span>
                </div>
              </div>
            </div>
            <div *ngIf="analyticsData.revenueByMonth.length === 0">
              üìà Revenue trend will appear here
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PROMOTIONS VIEW ===== -->
    <div *ngIf="currentView === 'promotions'">
      <div class="page-header">
        <button class="back-btn" (click)="goToDashboard()">‚Üê Back to Dashboard</button>
        <h1 class="page-title">Promotions & Deals</h1>
      </div>

      <!-- Success/Error Messages -->
      <div *ngIf="productSuccess" class="alert alert-success">
        {{productSuccess}}
      </div>
      <div *ngIf="productError" class="alert alert-error">
        {{productError}}
      </div>

      <div class="promotions-container">
        <!-- Create New Offer -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Create New Offer</h3>
          </div>
          <form class="offer-form">
            <div class="form-row">
              <div class="form-group">
                <label>Offer Title</label>
                <input type="text" [(ngModel)]="newOffer.title" name="offerTitle" class="form-input"
                  placeholder="Enter offer title">
              </div>
              <div class="form-group">
                <label>Discount Type</label>
                <select [(ngModel)]="newOffer.discountType" name="discountType" class="form-select">
                  <option value="percentage">Percentage</option>
                  <option value="fixed">Fixed Amount</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Description</label>
              <textarea [(ngModel)]="newOffer.description" name="offerDescription" class="form-textarea" rows="3"
                placeholder="Describe your offer"></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Discount Value</label>
                <input type="number" [(ngModel)]="newOffer.discountValue" name="discountValue" class="form-input"
                  placeholder="0" min="0">
              </div>
              <div class="form-group">
                <label>Valid From</label>
                <input type="date" [(ngModel)]="newOffer.validFrom" name="validFrom" class="form-input">
              </div>
              <div class="form-group">
                <label>Valid To</label>
                <input type="date" [(ngModel)]="newOffer.validTo" name="validTo" class="form-input">
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-primary" (click)="onCreateOffer()">Create Offer</button>
            </div>
          </form>
        </div>

        <!-- Active Offers -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Active Offers</h3>
          </div>
          <div *ngIf="specialOffers.length === 0" class="empty-state">
            <p>No offers created yet</p>
            <small>Create your first promotional offer above</small>
          </div>

          <div class="offers-grid" *ngIf="specialOffers.length > 0">
            <div *ngFor="let offer of specialOffers" class="offer-card">
              <div class="offer-header">
                <h4 class="offer-title">{{offer.title}}</h4>
                <div class="offer-actions">
                  <button class="btn-icon" (click)="toggleOfferStatus(offer.id)"
                    [title]="offer.isActive ? 'Deactivate' : 'Activate'">
                    {{offer.isActive ? 'üî•' : '‚è∏Ô∏è'}}
                  </button>
                  <button class="btn-icon" (click)="deleteOffer(offer.id)" title="Delete">üóëÔ∏è</button>
                </div>
              </div>
              <div class="offer-content">
                <p class="offer-description">{{offer.description}}</p>
                <div class="offer-details">
                  <span class="offer-discount">
                    {{offer.discountValue}}{{offer.discountType === 'percentage' ? '%' : ' KSh'}} OFF
                  </span>
                  <span class="offer-validity">
                    {{formatDate(offer.validFrom)}} - {{formatDate(offer.validTo)}}
                  </span>
                </div>
                <div class="offer-status">
                  <span class="status-badge" [ngClass]="offer.isActive ? 'delivered' : 'cancelled'">
                    {{offer.isActive ? 'Active' : 'Inactive'}}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PROFILE VIEW ===== -->
    <div *ngIf="currentView === 'profile'">
      <div class="page-header">
        <button class="back-btn" (click)="goToDashboard()"
          [disabled]="!profileLoading && !sellerProfile && !editingProfile">
          ‚Üê Back to Dashboard
        </button>
        <h1 class="page-title">Business Profile</h1>
        <button *ngIf="sellerProfile && !editingProfile" class="btn btn-primary" (click)="onEditProfile()">
          ‚úèÔ∏è Edit Profile
        </button>
      </div>

      <!-- Loading State -->
      <div *ngIf="profileLoading" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading profile...</p>
      </div>

      <!-- Success/Error Messages -->
      <div *ngIf="profileSuccess" class="alert alert-success">
        {{profileSuccess}}
      </div>
      <div *ngIf="profileError" class="alert alert-error">
        {{profileError}}
      </div>

      <!-- No Profile Yet - Create Form -->
      <div *ngIf="!profileLoading && !sellerProfile && !editingProfile">
        <div *ngIf="userRole?.toLowerCase() === 'seller'; else nonSeller">
          <div class="card">
        <div class="card-header">
          <h2 class="card-title">Create Your Business Profile</h2>
        </div>
        <div style="text-align: center; padding: 2rem 0; color: #6b7280;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üè™</div>
              <p style="margin-bottom: 1rem; font-size: 1.1rem;">You don't have a business profile yet.</p>
              <p style="margin-bottom: 2rem; color: #9ca3af;">As a seller, you can create your business profile to start
                selling on TechWave.</p>
              <button class="btn btn-primary" (click)="editingProfile = true">
                Create Business Profile
              </button>
            </div>
          </div>
        </div>

        <ng-template #nonSeller>
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Business Profile Required</h2>
            </div>
            <div style="text-align: center; padding: 2rem 1.5rem; color: #6b7280;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùó</div>
              <p style="margin-bottom: 1rem; font-size: 1.05rem;">
                Only users with the seller role can create a business profile.
              </p>
              <p style="margin-bottom: 1rem; color: #9ca3af;">
                If you believe you should have seller access, please contact Customer Care to request seller enrollment.
              </p>
              <div style="display:flex; gap:0.5rem; justify-content:center; margin-top:1rem;">
                <a class="btn btn-secondary" href="mailto:support@techwave.com">Email Customer Care</a>
                <a class="btn btn-primary" routerLink="/help">Contact Support</a>
              </div>
              <div style="margin-top:1rem; color:#9ca3af; font-size:0.9rem;">
                Logged in as: <strong>{{userName}}</strong> ({{userRole || 'N/A'}})
              </div>
            </div>
          </div>
        </ng-template>
      </div>

      <!-- View Profile (Not Editing) -->
      <div *ngIf="!profileLoading && sellerProfile && !editingProfile">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Business Information</h2>
          </div>

          <div style="display: grid; gap: 2rem;">
            <!-- Business Name -->
            <div class="profile-field">
              <label class="profile-label">Business Name</label>
              <div class="profile-value">{{sellerProfile.business_name}}</div>
            </div>

            <!-- Tax ID -->
            <div class="profile-field">
              <label class="profile-label">Tax ID / KRA PIN</label>
              <div class="profile-value">{{sellerProfile.tax_id}}</div>
            </div>

            <!-- Business License -->
            <div class="profile-field">
              <label class="profile-label">Business License Number</label>
              <div class="profile-value">{{sellerProfile.business_license}}</div>
            </div>

            <!-- Total Sales (Read Only) -->
            <div class="profile-field" *ngIf="sellerProfile.total_sales !== undefined">
              <label class="profile-label">Total Sales</label>
              <div class="profile-value" style="color: #10b981; font-weight: 600; font-size: 1.2rem;">
                {{formatCurrency(sellerProfile.total_sales || 0)}}
              </div>
            </div>

            <!-- Account Info -->
            <div class="profile-field" *ngIf="sellerProfile.name || sellerProfile.email || sellerProfile.phone">
              <label class="profile-label">Account Information</label>
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div *ngIf="sellerProfile.name" style="color: #6b7280;">
                  <strong>Name:</strong> {{sellerProfile.name}}
                </div>
                <div *ngIf="sellerProfile.email" style="color: #6b7280;">
                  <strong>Email:</strong> {{sellerProfile.email}}
                </div>
                <div *ngIf="sellerProfile.phone" style="color: #6b7280;">
                  <strong>Phone:</strong> {{sellerProfile.phone}}
                </div>
              </div>
            </div>

            <!-- Member Since -->
            <div class="profile-field" *ngIf="sellerProfile.created_at">
              <label class="profile-label">Member Since</label>
              <div class="profile-value">{{formatDate(sellerProfile.created_at)}}</div>
            </div>
          </div>
        </div>

        <!-- Profile Stats -->
        <div
          style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-title">Profile Status</div>
                <div class="stat-value" style="font-size: 1.5rem;">
                  <span class="status-badge delivered">‚úì Active</span>
                </div>
              </div>
              <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                ‚úì
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-title">Business Verified</div>
                <div class="stat-value" style="font-size: 1.5rem;">
                  <span class="status-badge processing">‚è≥ Pending</span>
                </div>
              </div>
              <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                üîç
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Profile Form -->
      <div *ngIf="editingProfile || (!profileLoading && !sellerProfile && editingProfile)">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              {{sellerProfile ? 'Edit Business Profile' : 'Create Business Profile'}}
            </h2>
          </div>

          <form class="product-form">
            <div class="form-group">
              <label for="businessName">Business Name *</label>
              <input type="text" id="businessName" [(ngModel)]="profileForm.business_name" name="businessName"
                class="form-input" placeholder="Enter your business name" required>
              <small style="color: #6b7280; font-size: 0.8rem;">
                This is the name that will appear on your products and store page.
              </small>
            </div>

            <div class="form-group">
              <label for="taxId">Tax ID / KRA PIN *</label>
              <input type="text" id="taxId" [(ngModel)]="profileForm.tax_id" name="taxId" class="form-input"
                placeholder="Enter your Tax ID or KRA PIN" required>
              <small style="color: #6b7280; font-size: 0.8rem;">
                Your tax identification number for compliance purposes.
              </small>
            </div>

            <div class="form-group">
              <label for="businessLicense">Business License Number *</label>
              <input type="text" id="businessLicense" [(ngModel)]="profileForm.business_license" name="businessLicense"
                class="form-input" placeholder="Enter your business license number" required>
              <small style="color: #6b7280; font-size: 0.8rem;">
                Your official business registration or license number.
              </small>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" (click)="onCancelProfileEdit()"
                [disabled]="profileLoading">
                Cancel
              </button>
              <button type="button" class="btn btn-primary" (click)="onSaveProfile()" [disabled]="profileLoading">
                <span *ngIf="!profileLoading">
                  {{sellerProfile ? 'Update Profile' : 'Create Profile'}}
                </span>
                <span *ngIf="profileLoading">Saving...</span>
              </button>
            </div>
          </form>
        </div>

        <!-- Information Card -->
        <div class="card" style="margin-top: 2rem; background: #f8fafc; border: 2px dashed #cbd5e1;">
          <div style="display: flex; gap: 1rem; align-items: start;">
            <div style="font-size: 2rem;">‚ÑπÔ∏è</div>
            <div>
              <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; color: #1f2937;">
                Important Information
              </h3>
              <ul style="color: #6b7280; font-size: 0.9rem; padding-left: 1.5rem; line-height: 1.8;">
                <li>All fields marked with * are required to complete your profile.</li>
                <li>Your business information will be verified by our team.</li>
                <li>Accurate information helps build trust with customers.</li>
                <li>You can update your profile information at any time.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>